# Архитектура Telegram Analytics Bot

## Обзор системы

Telegram Analytics Bot - это MVP-бот для автоматического анализа рабочих сообщений в Telegram с использованием OpenAI GPT и архивированием в Google Drive/Sheets.

## Ключевые компоненты

### 1. Telegram Bot API
- **Библиотека**: `python-telegram-bot`
- **Поддержка**: Business Connection для доступа к личным чатам
- **Режим**: Long-polling для получения сообщений в реальном времени
- **Команды**: `/start`, `/help`, `/status`, `/filter`, `/analyze`

### 2. База данных SQLite
- **Файл**: `telegram_analytics.db`
- **Таблицы**:
  - `chats` - информация о чатах
  - `messages` - все сообщения
  - `runs` - записи о запусках анализа
  - `reports` - результаты анализа
  - `filters` - правила фильтрации

### 3. Система фильтрации
- **Allowlist/Denylist**: приоритетные списки чатов
- **Ключевые слова**: автоматическое определение рабочих сообщений
- **Логика**: Allowlist > Denylist > Ключевые слова

### 4. Анализ с OpenAI GPT
- **Модель**: GPT-4o
- **Промпт**: Фиксированный промпт бизнес-консультанта
- **Формат**: 3 блока (договоренности, риски, рекомендации)
- **Лимиты**: Управление токенами и контекстом

### 5. Планировщик APScheduler
- **Частота**: Каждый час
- **Триггер**: IntervalTrigger
- **Обработка**: Предотвращение дублирования и пропусков

### 6. Архивирование
- **Google Drive**: Ежедневные TXT файлы
- **Google Sheets**: Индекс отчетов для поиска
- **Структура**: Папка `TelegramReports/YYYY-MM-DD.txt`

## Потоки данных

### 1. Ingest (Получение сообщений)
```
Telegram → Bot API → MessageHandler → SQLite
```

### 2. Filter (Фильтрация)
```
SQLite → MessageFilter → Рабочие сообщения
```

### 3. Analyze (Анализ)
```
Рабочие сообщения → GPT API → Структурированный отчет
```

### 4. Notify (Уведомления)
```
Отчет → Telegram Bot → Личный чат пользователя
```

### 5. Archive (Архивирование)
```
Отчет → Google Drive TXT + Google Sheets индекс
```

## Архитектурные решения

### Telegram Business API
- **Проблема**: Доступ к личным чатам через обычный Bot API невозможен
- **Решение**: Использование Telegram Business → Chatbots для подключения бота к аккаунту
- **Настройка**: Ручная привязка в настройках приложения

### SQLite как основное хранилище
- **Преимущества**: Простота, встроенность, надежность
- **Схема**: Нормализованная структура с индексами
- **Масштабирование**: Достаточно для MVP

### Фильтрация сообщений
- **Двухуровневая**: По чатам и по содержимому
- **Гибкость**: Пользовательские правила + автоматические ключевые слова
- **Производительность**: Индексы в БД

### Архивирование
- **Двойное**: Google Drive (контент) + Google Sheets (поиск)
- **Структура**: Ежедневные файлы с конкатенацией
- **Индекс**: Быстрый поиск по дате и чату

## Безопасность

### API ключи
- **Хранение**: Переменные окружения
- **Файлы**: `.env` в `.gitignore`
- **Ротация**: Поддержка смены ключей

### Данные
- **Локальность**: SQLite на сервере
- **Шифрование**: Google Drive API с OAuth2
- **Логирование**: Без конфиденциальных данных

## Масштабирование

### Горизонтальное
- **Боты**: Несколько экземпляров с разными токенами
- **База**: Репликация SQLite или миграция на PostgreSQL
- **API**: Rate limiting и пулы соединений

### Вертикальное
- **Память**: Кэширование результатов GPT
- **CPU**: Асинхронная обработка
- **Диск**: Архивирование старых данных

## Мониторинг

### Логирование
- **Уровни**: DEBUG, INFO, WARNING, ERROR
- **Файлы**: `telegram_analytics.log`
- **Метрики**: Время выполнения, количество сообщений

### Ошибки
- **Обработка**: Try-catch блоки во всех компонентах
- **Восстановление**: Graceful degradation
- **Уведомления**: Отправка ошибок в Telegram

## Деплой

### Платформы
- **Рекомендуемые**: Render, Railway, Fly.io
- **Альтернативы**: VPS, Docker контейнеры
- **Требования**: Python 3.11+, постоянное подключение

### Переменные окружения
```bash
TELEGRAM_BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_openai_key
GOOGLE_CREDENTIALS_FILE=credentials.json
TARGET_USER_ID=your_telegram_id
```

### Запуск
```bash
python -m app.main
```

## Ограничения MVP

### Telegram
- **Секретные чаты**: Не поддерживаются
- **Бизнес API**: Требует ручной настройки
- **Rate limits**: 30 сообщений в секунду

### OpenAI
- **Токены**: Лимиты по модели
- **Стоимость**: ~$0.01 за анализ
- **Контекст**: Максимум 4000 токенов

### Google API
- **Квоты**: 100 запросов в день
- **Размер**: 10MB на файл
- **Авторизация**: OAuth2 flow

## Будущие улучшения

### Функциональность
- **Многоязычность**: Поддержка разных языков
- **Темы**: Категоризация по темам
- **Интеграции**: Slack, Discord, Email
- **ML**: Собственные модели анализа

### Техническая
- **Микросервисы**: Разделение компонентов
- **Очереди**: Redis/RabbitMQ для обработки
- **Кэш**: Redis для результатов
- **Метрики**: Prometheus + Grafana

### UX
- **Веб-интерфейс**: Управление фильтрами
- **Дашборд**: Визуализация аналитики
- **API**: REST API для интеграций
- **Мобильное приложение**: Управление ботом
